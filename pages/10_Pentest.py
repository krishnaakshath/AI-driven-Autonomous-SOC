import streamlit as st
import os
import sys
import json
import socket
from datetime import datetime

sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

st.set_page_config(page_title="Penetration Testing | SOC", page_icon="P", layout="wide")

st.markdown("""
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
    html, body, [class*="css"] { font-family: 'Inter', sans-serif; }
    
    .pentest-header {
        background: linear-gradient(135deg, rgba(255, 68, 68, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
        border: 1px solid rgba(255, 68, 68, 0.4);
        border-radius: 16px;
        padding: 1.5rem 2rem;
        margin-bottom: 2rem;
    }
    
    .scan-box {
        background: rgba(26, 31, 46, 0.9);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
    }
    
    .port-open {
        background: rgba(0, 200, 83, 0.15);
        border-left: 4px solid #00C853;
        padding: 0.8rem 1rem;
        margin: 0.3rem 0;
        border-radius: 4px;
    }
    
    .port-closed {
        background: rgba(139, 149, 165, 0.1);
        border-left: 4px solid #8B95A5;
        padding: 0.5rem 1rem;
        margin: 0.2rem 0;
        border-radius: 4px;
    }
    
    .vuln-critical {
        background: rgba(255, 68, 68, 0.2);
        border-left: 4px solid #FF4444;
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: 4px;
    }
    
    .vuln-high {
        background: rgba(255, 140, 0, 0.15);
        border-left: 4px solid #FF8C00;
        padding: 1rem;
        margin: 0.5rem 0;
        border-radius: 4px;
    }
    
    .host-alive {
        background: rgba(0, 212, 255, 0.1);
        border: 1px solid rgba(0, 212, 255, 0.3);
        border-radius: 8px;
        padding: 0.8rem 1rem;
        margin: 0.3rem 0;
    }
    
    #MainMenu {visibility: hidden;}
    footer {visibility: hidden;}
</style>
""", unsafe_allow_html=True)

from auth.auth_manager import check_auth, show_user_info

user = check_auth()
if not user:
    st.switch_page("pages/0_Login.py")
    st.stop()

if user.get('role') != 'admin':
    st.error("Access Denied - Admin privileges required for penetration testing")
    st.stop()

show_user_info(user)

from services.security_scanner import (
    run_port_scan, run_ping, run_network_discovery, 
    run_full_scan, check_vulnerabilities
)

SCAN_HISTORY_FILE = ".scan_history.json"


def save_scan(scan_data):
    history = []
    if os.path.exists(SCAN_HISTORY_FILE):
        try:
            with open(SCAN_HISTORY_FILE, 'r') as f:
                history = json.load(f)
        except:
            pass
    
    scan_data["scanned_by"] = user.get("email")
    history.append(scan_data)
    
    with open(SCAN_HISTORY_FILE, 'w') as f:
        json.dump(history[-50:], f, indent=2)


st.markdown("""
    <div class="pentest-header">
        <h1 style="margin: 0; color: #FAFAFA;">Penetration Testing Suite</h1>
        <p style="color: #8B95A5; margin: 0.5rem 0 0 0;">Real network security scanning and vulnerability assessment</p>
    </div>
""", unsafe_allow_html=True)

st.warning("**Authorized Use Only** - Only scan networks and systems you own or have written permission to test.")

tab1, tab2, tab3, tab4 = st.tabs(["Port Scanner", "Network Discovery", "Full Scan", "Scan History"])

with tab1:
    st.markdown("### Port Scanner")
    st.markdown("Scan a target IP for open ports and running services")
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        target_ip = st.text_input("Target IP Address", placeholder="e.g., 192.168.1.1", key="port_target")
    
    with col2:
        scan_type = st.selectbox("Scan Type", [
            "Quick Scan (Top 22 ports)",
            "Web Ports (80, 443, 8080)",
            "Database Ports",
            "Full Scan (1-1024)"
        ])
    
    port_lists = {
        "Quick Scan (Top 22 ports)": [21, 22, 23, 25, 53, 80, 110, 135, 139, 143, 443, 445, 993, 995, 1433, 1521, 3306, 3389, 5432, 5900, 8080, 8443],
        "Web Ports (80, 443, 8080)": [80, 443, 8080, 8443, 8000, 8888, 9000],
        "Database Ports": [1433, 1521, 3306, 5432, 27017, 6379, 9200],
        "Full Scan (1-1024)": list(range(1, 1025))
    }
    
    if st.button("Start Port Scan", type="primary", key="start_port_scan"):
        if target_ip:
            with st.spinner(f"Scanning {target_ip}..."):
                result = run_port_scan(target_ip, port_lists[scan_type])
                save_scan({"type": "port_scan", "result": result})
                
                st.markdown("### Scan Results")
                
                open_ports = result.get("open_ports", [])
                
                col1, col2, col3 = st.columns(3)
                with col1:
                    st.metric("Open Ports", len(open_ports))
                with col2:
                    st.metric("Closed Ports", len(result.get("closed_ports", [])))
                with col3:
                    st.metric("Filtered", len(result.get("filtered_ports", [])))
                
                if open_ports:
                    st.markdown("#### Open Ports Found")
                    for port_info in open_ports:
                        st.markdown(f"""
                            <div class="port-open">
                                <strong>Port {port_info['port']}</strong> - {port_info['service']}
                                <span style="float: right; color: #00C853;">OPEN</span>
                            </div>
                        """, unsafe_allow_html=True)
                    
                    vulns = check_vulnerabilities({"ports": result})
                    if vulns:
                        st.markdown("#### Security Findings")
                        for vuln in vulns:
                            vuln_class = "vuln-critical" if vuln["severity"] == "CRITICAL" else "vuln-high"
                            st.markdown(f"""
                                <div class="{vuln_class}">
                                    <strong>[{vuln['severity']}] Port {vuln['port']} - {vuln['service']}</strong>
                                    <p style="margin: 0.5rem 0 0 0; color: #8B95A5;">{vuln['issue']}</p>
                                    <p style="margin: 0.3rem 0 0 0; color: #00D4FF;">Recommendation: {vuln['recommendation']}</p>
                                </div>
                            """, unsafe_allow_html=True)
                else:
                    st.success("No open ports found - target appears secure or offline")
        else:
            st.warning("Please enter a target IP address")

with tab2:
    st.markdown("### Network Discovery")
    st.markdown("Discover all live hosts on a network subnet")
    
    try:
        s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
        s.connect(("8.8.8.8", 80))
        local_ip = s.getsockname()[0]
        s.close()
        network_prefix = ".".join(local_ip.split(".")[:3])
    except:
        network_prefix = "192.168.1"
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        network = st.text_input("Network Prefix", value=network_prefix, help="e.g., 192.168.1 will scan 192.168.1.1-254")
    
    if st.button("Discover Hosts", type="primary", key="start_discovery"):
        if network:
            with st.spinner(f"Scanning {network}.1-254... This may take a minute..."):
                results = run_network_discovery(network)
                save_scan({"type": "network_discovery", "network": network, "hosts": len(results)})
                
                st.metric("Live Hosts Found", len(results))
                
                if results:
                    st.markdown("#### Discovered Hosts")
                    for host in results:
                        st.markdown(f"""
                            <div class="host-alive">
                                <strong>{host['target']}</strong>
                                <span style="float: right; color: #00C853;">{host['response_time']}ms</span>
                            </div>
                        """, unsafe_allow_html=True)
                else:
                    st.info("No live hosts found on this network")

with tab3:
    st.markdown("### Full Security Scan")
    st.markdown("Comprehensive scan with port detection, banner grabbing, and vulnerability assessment")
    
    target = st.text_input("Target IP", placeholder="e.g., 192.168.1.1", key="full_target")
    
    if st.button("Run Full Scan", type="primary", key="start_full"):
        if target:
            progress = st.progress(0)
            status = st.empty()
            
            status.text("Step 1/4: Ping check...")
            progress.progress(25)
            
            with st.spinner("Running comprehensive security scan..."):
                result = run_full_scan(target)
                save_scan({"type": "full_scan", "result": result})
                
                progress.progress(100)
                status.text("Scan complete!")
                
                st.markdown("### Full Scan Report")
                
                st.markdown("#### Host Status")
                if result["ping"]["alive"]:
                    st.success(f"Host is ALIVE (Response: {result['ping']['response_time']}ms)")
                else:
                    st.warning("Host did not respond to ping (may have firewall)")
                
                st.markdown("#### Open Ports")
                open_ports = result.get("ports", {}).get("open_ports", [])
                if open_ports:
                    for port_info in open_ports:
                        banner = result.get("banners", {}).get(port_info["port"], "")
                        st.markdown(f"""
                            <div class="port-open">
                                <strong>Port {port_info['port']}</strong> - {port_info['service']}
                                {f'<p style="color: #8B95A5; font-size: 0.85rem; margin: 0.3rem 0 0 0;">{banner[:100]}</p>' if banner else ''}
                            </div>
                        """, unsafe_allow_html=True)
                else:
                    st.info("No open ports detected")
                
                vulns = check_vulnerabilities(result)
                if vulns:
                    st.markdown("#### Vulnerabilities Detected")
                    for vuln in vulns:
                        severity_color = "#FF4444" if vuln["severity"] == "CRITICAL" else "#FF8C00"
                        st.markdown(f"""
                            <div class="{'vuln-critical' if vuln['severity'] == 'CRITICAL' else 'vuln-high'}">
                                <strong style="color: {severity_color};">[{vuln['severity']}]</strong> 
                                Port {vuln['port']} ({vuln['service']}) - {vuln['issue']}
                                <p style="margin: 0.5rem 0 0 0; color: #00D4FF;">{vuln['recommendation']}</p>
                            </div>
                        """, unsafe_allow_html=True)
                else:
                    st.success("No critical vulnerabilities detected")
        else:
            st.warning("Please enter a target IP")

with tab4:
    st.markdown("### Scan History")
    
    if os.path.exists(SCAN_HISTORY_FILE):
        try:
            with open(SCAN_HISTORY_FILE, 'r') as f:
                history = json.load(f)
            
            if history:
                for scan in reversed(history[-20:]):
                    scan_type = scan.get("type", "unknown")
                    timestamp = scan.get("result", {}).get("timestamp", scan.get("timestamp", "Unknown"))
                    scanned_by = scan.get("scanned_by", "Unknown")
                    
                    with st.expander(f"{scan_type.upper()} - {timestamp[:19]}"):
                        st.json(scan)
                
                if st.button("Clear History"):
                    os.remove(SCAN_HISTORY_FILE)
                    st.success("History cleared")
                    st.rerun()
            else:
                st.info("No scan history yet")
        except:
            st.info("No scan history yet")
    else:
        st.info("No scan history yet. Run a scan to get started!")

st.markdown("---")
st.markdown('<div style="text-align: center; color: #8B95A5; padding: 1rem;"><p style="margin: 0;">AI-Driven Autonomous SOC | Penetration Testing Suite</p></div>', unsafe_allow_html=True)
